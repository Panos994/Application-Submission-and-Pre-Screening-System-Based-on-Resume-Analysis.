pipeline {
    agent any
    environment {
        BACKEND_IMAGE = 'ghcr.io/panos994/application-submission-and-pre-screening-system-based-on-resume-analysis/backend:1.0'
        FRONTEND_IMAGE = 'ghcr.io/panos994/application-submission-and-pre-screening-system-based-on-resume-frontend:latest'
    }
    stages {
        stage('Docker Login to GHCR') {
            steps {
                script {
                    def github_username = "Panos994"
                    def github_token = "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"
                    // Log in to GHCR using the token and username
                    sh "echo ${github_token} | docker login ghcr.io -u ${github_username} --password-stdin"
                }
            }
        }
        stage('Pull Backend Image') {
            steps {
                sh 'docker pull $BACKEND_IMAGE'
            }
        }
        stage('Pull Frontend Image') {
            steps {
                sh 'docker pull $FRONTEND_IMAGE'
            }
        }
        stage('Deploy to Kubernetes') {
            environment {
                KUBECONFIG = '/etc/rancher/k3s/k3s.yaml' // Path to kubeconfig file on EC2 instance
            }
            steps {
                // Applying database and MinIO manifests using relative paths from the repository
                sh 'kubectl apply -f k3s/database/deployment.yaml'
                sh 'kubectl apply -f k3s/database/service.yaml'
                sh 'kubectl apply -f k3s/minio'

                // Apply the backend and frontend images from GitHub Packages
                sh 'kubectl set image deployment/backend backend=$BACKEND_IMAGE'
                sh 'kubectl set image deployment/frontend frontend=$FRONTEND_IMAGE'
            }
        }
    }
}
