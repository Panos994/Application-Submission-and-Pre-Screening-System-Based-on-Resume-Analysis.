pipeline {
    agent any
    environment {
        // Define the GitHub Package registry for backend and frontend images
        BACKEND_IMAGE = 'ghcr.io/panos994/application-submission-and-pre-screening-system-based-on-resume-analysis/backend:1.0'
        FRONTEND_IMAGE = 'ghcr.io/panos994/application-submission-and-pre-screening-system-based-on-resume-frontend:latest'
    }
    stages {
        stage('Pull Backend Image') {
            steps {
                // Pull the backend image from GitHub Packages
                sh 'docker pull $BACKEND_IMAGE'
            }
        }
        stage('Pull Frontend Image') {
            steps {
                // Pull the frontend image from GitHub Packages
                sh 'docker pull $FRONTEND_IMAGE'
            }
        }
        stage('Deploy to Kubernetes') {
            environment {
                KUBECONFIG = '/etc/rancher/k3s/k3s.yaml' // Path to kubeconfig file on EC2 instance
            }
            steps {
                // Applying database and MinIO manifests
                sh 'kubectl apply -f /home/it2021154/Desktop/DraftJobSystem/Application-Submission-and-Pre-Screening-System-Based-on-Resume-Analysis/k3s/database'
                sh 'kubectl apply -f /home/it2021154/Desktop/DraftJobSystem/Application-Submission-and-Pre-Screening-System-Based-on-Resume-Analysis/k3s/minio'
                // Apply the backend and frontend images from GitHub Packages
                sh 'kubectl set image deployment/backend backend=$BACKEND_IMAGE'
                sh 'kubectl set image deployment/frontend frontend=$FRONTEND_IMAGE'
            }
        }
    }
}
